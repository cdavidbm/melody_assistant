{% extends "base.html" %}

{% block content %}
<div class="main-grid">
    <!-- ===== Form Column ===== -->
    <div class="form-column">
        <div class="form-header">
            <h2>Configuracion</h2>
            <button type="button" class="btn-reset" onclick="resetForm()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                    <path d="M21 3v5h-5"/>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                    <path d="M3 21v-5h5"/>
                </svg>
                Restablecer
            </button>
        </div>

        <!-- Mode Tabs -->
        <div class="mode-tabs">
            <button type="button" class="mode-tab active" data-mode="spontaneous">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2v8l4-4"/>
                    <path d="m8 6 4 4"/>
                    <circle cx="12" cy="18" r="4"/>
                </svg>
                Generacion Espontanea
            </button>
            <button type="button" class="mode-tab" data-mode="develop">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3v12"/>
                    <path d="m8 11 4 4 4-4"/>
                    <path d="M8 21h8"/>
                    <path d="M3 7h18"/>
                </svg>
                Desarrollar Idea
            </button>
        </div>

        <!-- ===== MODE 1: Spontaneous Generation ===== -->
        <div class="mode-content active" id="mode-spontaneous">
            <form id="melody-form" hx-post="/generate" hx-target="#result-container" hx-swap="innerHTML">
                <input type="hidden" name="generation_mode" value="spontaneous">
                <div class="form-sections">
                    <!-- Configuracion Tonal -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 18V5l12-2v13"/>
                                    <circle cx="6" cy="18" r="3"/>
                                    <circle cx="18" cy="16" r="3"/>
                                </svg>
                                <span class="section-title">Configuracion Tonal</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Tonalidad</label>
                                    <select name="key" id="key" class="form-select">
                                        {% for k in keys %}
                                        <option value="{{ k }}" {{ 'selected' if k == defaults.key else '' }}>{{ k }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Modo / Escala</label>
                                    <select name="mode" id="mode" class="form-select">
                                        <optgroup label="Modos Diatonicos">
                                            <option value="1" {{ 'selected' if defaults.mode == '1' else '' }}>Major (Jonico)</option>
                                            <option value="2" {{ 'selected' if defaults.mode == '2' else '' }}>Dorian (Dorico)</option>
                                            <option value="3" {{ 'selected' if defaults.mode == '3' else '' }}>Phrygian (Frigio)</option>
                                            <option value="4" {{ 'selected' if defaults.mode == '4' else '' }}>Lydian (Lidio)</option>
                                            <option value="5" {{ 'selected' if defaults.mode == '5' else '' }}>Mixolydian (Mixolidio)</option>
                                            <option value="6" {{ 'selected' if defaults.mode == '6' else '' }}>Minor (Eolico)</option>
                                            <option value="7" {{ 'selected' if defaults.mode == '7' else '' }}>Locrian (Locrio)</option>
                                        </optgroup>
                                        <optgroup label="Escalas Menores">
                                            <option value="8" {{ 'selected' if defaults.mode == '8' else '' }}>Menor Armonica</option>
                                            <option value="9" {{ 'selected' if defaults.mode == '9' else '' }}>Menor Melodica</option>
                                        </optgroup>
                                        <optgroup label="Modos de Menor Armonica">
                                            <option value="10" {{ 'selected' if defaults.mode == '10' else '' }}>Locrio nat6</option>
                                            <option value="11" {{ 'selected' if defaults.mode == '11' else '' }}>Jonico aug5</option>
                                            <option value="12" {{ 'selected' if defaults.mode == '12' else '' }}>Dorico #4</option>
                                            <option value="13" {{ 'selected' if defaults.mode == '13' else '' }}>Frigio Dominante</option>
                                            <option value="14" {{ 'selected' if defaults.mode == '14' else '' }}>Lidio #2</option>
                                            <option value="15" {{ 'selected' if defaults.mode == '15' else '' }}>Superlocrio</option>
                                        </optgroup>
                                        <optgroup label="Modos de Menor Melodica">
                                            <option value="16" {{ 'selected' if defaults.mode == '16' else '' }}>Dorico b2</option>
                                            <option value="17" {{ 'selected' if defaults.mode == '17' else '' }}>Lidio Aumentado</option>
                                            <option value="18" {{ 'selected' if defaults.mode == '18' else '' }}>Lidio Dominante</option>
                                            <option value="19" {{ 'selected' if defaults.mode == '19' else '' }}>Mixolidio b6</option>
                                            <option value="20" {{ 'selected' if defaults.mode == '20' else '' }}>Locrio nat2</option>
                                            <option value="21" {{ 'selected' if defaults.mode == '21' else '' }}>Alterado</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuracion Metrica -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span class="section-title">Configuracion Metrica</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Compas</label>
                                    <div class="meter-input">
                                        <select name="meter_num" id="meter_num" class="form-select">
                                            {% for n in [2, 3, 4, 5, 6, 7, 9, 12] %}
                                            <option value="{{ n }}" {{ 'selected' if n == defaults.meter_num else '' }}>{{ n }}</option>
                                            {% endfor %}
                                        </select>
                                        <span class="meter-divider">/</span>
                                        <select name="meter_den" id="meter_den" class="form-select">
                                            {% for d in [2, 4, 8, 16] %}
                                            <option value="{{ d }}" {{ 'selected' if d == defaults.meter_den else '' }}>{{ d }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Numero de compases</label>
                                    <select name="num_measures" id="num_measures" class="form-select">
                                        {% for m in [2, 4, 8, 12, 16, 24, 32] %}
                                        <option value="{{ m }}" {{ 'selected' if m == defaults.num_measures else '' }}>{{ m }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuracion Ritmica -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                                </svg>
                                <span class="section-title">Configuracion Ritmica</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Complejidad ritmica</label>
                                    <select name="complexity" id="complexity" class="form-select">
                                        <option value="1" {{ 'selected' if defaults.complexity == 1 else '' }}>Simple (negras y corcheas)</option>
                                        <option value="2" {{ 'selected' if defaults.complexity == 2 else '' }}>Moderado (incluye puntillos)</option>
                                        <option value="3" {{ 'selected' if defaults.complexity == 3 else '' }}>Complejo (semicorcheas)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tipo de impulso</label>
                                    <select name="impulse" id="impulse" class="form-select">
                                        {% for value, label in impulse_options %}
                                        <option value="{{ value }}" {{ 'selected' if value == defaults.impulse else '' }}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox-wrapper">
                                    <input type="checkbox" name="use_rests" id="use_rests" class="form-checkbox" {{ 'checked' if defaults.use_rests else '' }}>
                                    <span class="form-checkbox-label">Usar silencios como respiraciones</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Configuracion Melodica -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M2 20h.01"/>
                                    <path d="M7 20v-4"/>
                                    <path d="M12 20v-8"/>
                                    <path d="M17 20V8"/>
                                    <path d="M22 4v16"/>
                                </svg>
                                <span class="section-title">Configuracion Melodica</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Posicion del climax</label>
                                    <div class="form-range-wrapper">
                                        <input type="range" name="climax_position" id="climax_position" class="form-range"
                                               min="0.1" max="0.9" step="0.05" value="{{ defaults.climax_position }}">
                                        <span class="range-value" id="climax_value">{{ defaults.climax_position }}</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Libertad de variacion</label>
                                    <select name="variation_freedom" id="variation_freedom" class="form-select">
                                        <option value="1" {{ 'selected' if defaults.variation_freedom == 1 else '' }}>Estricta (conservador)</option>
                                        <option value="2" {{ 'selected' if defaults.variation_freedom == 2 else '' }}>Moderada (equilibrio)</option>
                                        <option value="3" {{ 'selected' if defaults.variation_freedom == 3 else '' }}>Libre (creativo)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox-wrapper">
                                    <input type="checkbox" name="use_tenoris" id="use_tenoris" class="form-checkbox" {{ 'checked' if defaults.use_tenoris else '' }}>
                                    <span class="form-checkbox-label">Usar tenoris (quinta como nota sostenedora)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Metodo de Generacion -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 3v18"/>
                                    <rect width="6" height="6" x="9" y="9" rx="1"/>
                                    <path d="M3 9h6V6"/>
                                    <path d="M3 15h6v3"/>
                                    <path d="M21 9h-6V6"/>
                                    <path d="M21 15h-6v3"/>
                                </svg>
                                <span class="section-title">Metodo de Generacion</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label class="form-label">Metodo</label>
                                <select name="generation_method" id="generation_method" class="form-select">
                                    {% for value, label in generation_methods %}
                                    <option value="{{ value }}" {{ 'selected' if value == defaults.generation_method else '' }}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="conditional-section" id="genetic-options" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Generaciones</label>
                                        <input type="number" name="genetic_generations" id="genetic_generations" class="form-input"
                                               min="5" max="100" value="{{ defaults.genetic_generations }}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Poblacion</label>
                                        <input type="number" name="genetic_population" id="genetic_population" class="form-input"
                                               min="10" max="200" value="{{ defaults.genetic_population }}">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-checkbox-wrapper">
                                        <input type="checkbox" name="genetic_markov_polish" id="genetic_markov_polish" class="form-checkbox" {{ 'checked' if defaults.genetic_markov_polish else '' }}>
                                        <span class="form-checkbox-label">Pulido Markov (suaviza voice leading)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bajo Armonico -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 18V5l12-2v13"/>
                                    <ellipse cx="6" cy="18" rx="4" ry="2"/>
                                    <ellipse cx="18" cy="16" rx="4" ry="2"/>
                                </svg>
                                <span class="section-title">Bajo Armonico</span>
                                <span class="section-badge">Opcional</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label class="form-checkbox-wrapper">
                                    <input type="checkbox" name="add_bass" id="add_bass" class="form-checkbox" {{ 'checked' if defaults.add_bass else '' }}>
                                    <span class="form-checkbox-label">Agregar linea de bajo</span>
                                </label>
                            </div>
                            <div class="conditional-section" id="bass-options" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Estilo de bajo</label>
                                        <select name="bass_style" id="bass_style" class="form-select">
                                            {% for value, label in bass_styles %}
                                            <option value="{{ value }}" {{ 'selected' if value == defaults.bass_style else '' }}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Octava del bajo</label>
                                        <select name="bass_octave" id="bass_octave" class="form-select">
                                            <option value="2" {{ 'selected' if defaults.bass_octave == 2 else '' }}>2 (muy grave)</option>
                                            <option value="3" {{ 'selected' if defaults.bass_octave == 3 else '' }}>3 (grave)</option>
                                            <option value="4" {{ 'selected' if defaults.bass_octave == 4 else '' }}>4 (media)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cadenas de Markov -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="18" cy="5" r="3"/>
                                    <circle cx="6" cy="12" r="3"/>
                                    <circle cx="18" cy="19" r="3"/>
                                    <path d="M8.59 13.51 15.42 17.49"/>
                                    <path d="M15.41 6.51 8.59 10.49"/>
                                </svg>
                                <span class="section-title">Cadenas de Markov</span>
                                <span class="section-badge">Opcional</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label class="form-checkbox-wrapper">
                                    <input type="checkbox" name="use_markov" id="use_markov" class="form-checkbox" {{ 'checked' if defaults.use_markov else '' }}>
                                    <span class="form-checkbox-label">Usar cadenas de Markov</span>
                                </label>
                            </div>
                            <div class="conditional-section" id="markov-options">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Compositor de referencia</label>
                                        <select name="composer" id="composer" class="form-select">
                                            {% for value, label in composers %}
                                            <option value="{{ value }}" {{ 'selected' if value == defaults.composer else '' }}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Peso de Markov</label>
                                        <div class="form-range-wrapper">
                                            <input type="range" name="markov_weight" id="markov_weight" class="form-range"
                                                   min="0" max="1" step="0.1" value="{{ defaults.markov_weight }}">
                                            <span class="range-value" id="markov_value">{{ defaults.markov_weight }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Orden de la cadena</label>
                                    <select name="markov_order" id="markov_order" class="form-select">
                                        {% for value, label in markov_orders %}
                                        <option value="{{ value }}" {{ 'selected' if value == defaults.markov_order else '' }}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expresion Musical -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 2v8l4-4"/>
                                    <path d="m8 6 4 4"/>
                                    <rect width="18" height="8" x="3" y="14" rx="2"/>
                                </svg>
                                <span class="section-title">Expresion Musical</span>
                                <span class="section-badge">Opcional</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label class="form-label">Estilo de ornamentacion</label>
                                <select name="ornamentation_style" id="ornamentation_style" class="form-select">
                                    {% for value, label in ornamentation_styles %}
                                    <option value="{{ value }}" {{ 'selected' if value == defaults.ornamentation_style else '' }}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-checkbox-wrapper">
                                        <input type="checkbox" name="use_dynamics" id="use_dynamics" class="form-checkbox" {{ 'checked' if defaults.use_dynamics else '' }}>
                                        <span class="form-checkbox-label">Usar dinamicas automaticas</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-checkbox-wrapper">
                                        <input type="checkbox" name="use_articulations" id="use_articulations" class="form-checkbox" {{ 'checked' if defaults.use_articulations else '' }}>
                                        <span class="form-checkbox-label">Usar articulaciones</span>
                                    </label>
                                </div>
                            </div>
                            <div class="conditional-section" id="dynamics-options">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Dinamica base</label>
                                        <select name="base_dynamic" id="base_dynamic" class="form-select">
                                            {% for value, label in dynamic_levels %}
                                            <option value="{{ value }}" {{ 'selected' if value == defaults.base_dynamic else '' }}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dinamica de climax</label>
                                        <select name="climax_dynamic" id="climax_dynamic" class="form-select">
                                            {% for value, label in dynamic_levels %}
                                            <option value="{{ value }}" {{ 'selected' if value == defaults.climax_dynamic else '' }}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informacion de Partitura -->
                    <div class="section-card">
                        <div class="section-header collapsible" onclick="toggleSection(this)">
                            <div class="section-header-left">
                                <svg class="section-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                                <span class="section-title">Informacion de Partitura</span>
                            </div>
                            <svg class="section-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Titulo</label>
                                    <input type="text" name="title" id="title" class="form-input" value="{{ defaults.title }}" placeholder="Melodia Generada">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Compositor</label>
                                    <input type="text" name="score_composer" id="score_composer" class="form-input" value="{{ defaults.score_composer }}" placeholder="CompositorIA">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn-generate">
                        <span class="btn-text">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="6 3 20 12 6 21 6 3"/>
                            </svg>
                            Generar Melodia
                        </span>
                        <span class="btn-loading">
                            <span class="spinner"></span>
                            Generando...
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- ===== MODE 2: Develop Idea ===== -->
        <div class="mode-content" id="mode-develop">
            <form id="develop-form" hx-post="/generate" hx-target="#result-container" hx-swap="innerHTML">
                <input type="hidden" name="generation_mode" value="develop">

                <div class="section-card">
                    <div class="mode-info">
                        <svg class="mode-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4"/>
                            <path d="M12 8h.01"/>
                        </svg>
                        <div class="mode-info-text">
                            <strong>Desarrolla tu idea musical.</strong> Escribe un motivo o melodia en notacion LilyPond y el sistema lo desarrollara aplicando variaciones motivicas, manteniendo la esencia de tu idea original.
                        </div>
                    </div>

                    <div class="lilypond-editor">
                        <div class="editor-header">
                            <svg class="editor-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                <path d="m15 5 4 4"/>
                            </svg>
                            <div>
                                <div class="editor-title">Tu Idea Musical</div>
                                <div class="editor-subtitle">Escribe en formato LilyPond</div>
                            </div>
                        </div>

                        <div class="editor-container">
                            <textarea
                                name="user_motif"
                                id="user_motif"
                                class="editor-textarea"
                                placeholder="c'4 d' e' f' | g'2 e' | f'4 e' d' c' | d'1"
                                required></textarea>
                        </div>

                        <div class="editor-help">
                            <div class="help-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                    <path d="M12 17h.01"/>
                                </svg>
                                Ejemplos de notacion
                            </div>
                            <div class="help-examples">
                                <span class="help-example" onclick="insertExample(this)">c'4 d' e' f'</span>
                                <span class="help-example" onclick="insertExample(this)">g'2. fis'4</span>
                                <span class="help-example" onclick="insertExample(this)">e'8 d' c' b | a4 g</span>
                                <span class="help-example" onclick="insertExample(this)">a'4. b'8 c''4 a'</span>
                            </div>
                            <div class="help-note">
                                <code>c d e f g a b</code> = notas |
                                <code>'</code> = octava superior |
                                <code>1 2 4 8 16</code> = duraciones |
                                <code>.</code> = puntillo |
                                <code>|</code> = barra de compas
                            </div>
                        </div>
                    </div>

                    <!-- Development Options -->
                    <div class="develop-options">
                        <span class="section-title">Opciones de Desarrollo</span>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Compases a generar</label>
                                <select name="dev_num_measures" class="form-select">
                                    <option value="4">4 compases</option>
                                    <option value="8" selected>8 compases</option>
                                    <option value="12">12 compases</option>
                                    <option value="16">16 compases</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Intensidad de variacion</label>
                                <select name="dev_variation_intensity" class="form-select">
                                    <option value="1">Conservadora (pocas variaciones)</option>
                                    <option value="2" selected>Moderada (equilibrio)</option>
                                    <option value="3">Creativa (muchas variaciones)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Compas</label>
                                <div class="meter-input">
                                    <select name="dev_meter_num" class="form-select">
                                        {% for n in [2, 3, 4, 5, 6, 7, 9, 12] %}
                                        <option value="{{ n }}" {{ 'selected' if n == 4 else '' }}>{{ n }}</option>
                                        {% endfor %}
                                    </select>
                                    <span class="meter-divider">/</span>
                                    <select name="dev_meter_den" class="form-select">
                                        {% for d in [2, 4, 8, 16] %}
                                        <option value="{{ d }}" {{ 'selected' if d == 4 else '' }}>{{ d }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tonalidad de salida</label>
                                <select name="dev_key" class="form-select">
                                    <option value="auto" selected>Detectar automaticamente</option>
                                    {% for k in keys %}
                                    <option value="{{ k }}">{{ k }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-checkbox-wrapper">
                                <input type="checkbox" name="dev_add_bass" class="form-checkbox">
                                <span class="form-checkbox-label">Agregar linea de bajo armonico</span>
                            </label>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Titulo</label>
                                <input type="text" name="dev_title" class="form-input" value="Desarrollo de Idea" placeholder="Titulo de la pieza">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Compositor</label>
                                <input type="text" name="dev_composer" class="form-input" value="CompositorIA" placeholder="Tu nombre">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn-generate">
                        <span class="btn-text">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 3v12"/>
                                <path d="m8 11 4 4 4-4"/>
                                <path d="M8 21h8"/>
                            </svg>
                            Desarrollar Idea
                        </span>
                        <span class="btn-loading">
                            <span class="spinner"></span>
                            Desarrollando...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== Output Column ===== -->
    <div class="output-column">
        <div class="output-panel">
            <div class="output-tabs">
                <button type="button" class="output-tab active" data-tab="score">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    Partitura
                </button>
                <button type="button" class="output-tab" data-tab="audio">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18V5l12-2v13"/>
                        <circle cx="6" cy="18" r="3"/>
                        <circle cx="18" cy="16" r="3"/>
                    </svg>
                    Audio
                </button>
                <button type="button" class="output-tab" data-tab="code">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="16 18 22 12 16 6"/>
                        <polyline points="8 6 2 12 8 18"/>
                    </svg>
                    LilyPond
                </button>
            </div>
            <div class="output-content" id="result-container">
                <!-- Score tab (default) -->
                <div class="tab-pane active" id="tab-score">
                    <div class="output-empty">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 18V5l12-2v13"/>
                            <circle cx="6" cy="18" r="3"/>
                            <circle cx="18" cy="16" r="3"/>
                        </svg>
                        <p>La partitura aparecera aqui despues de generar</p>
                    </div>
                </div>
                <!-- Audio tab -->
                <div class="tab-pane" id="tab-audio">
                    <div class="output-empty">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                        </svg>
                        <p>El reproductor MIDI estara disponible despues de generar</p>
                    </div>
                </div>
                <!-- Code tab -->
                <div class="tab-pane" id="tab-code">
                    <div class="output-empty">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="16 18 22 12 16 6"/>
                            <polyline points="8 6 2 12 8 18"/>
                        </svg>
                        <p>El codigo LilyPond aparecera aqui despues de generar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Mode tab switching
    document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Update tab buttons
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            // Update content panels
            document.querySelectorAll('.mode-content').forEach(c => c.classList.remove('active'));
            const modeId = 'mode-' + this.dataset.mode;
            document.getElementById(modeId).classList.add('active');
        });
    });

    // Toggle section collapse
    function toggleSection(header) {
        const card = header.closest('.section-card');
        card.classList.toggle('collapsed');
    }

    // Reset form
    function resetForm() {
        const activeMode = document.querySelector('.mode-content.active');
        const form = activeMode.querySelector('form');
        if (form) {
            form.reset();
        }
        updateConditionalSections();
        updateRangeValues();
    }

    // Insert example into textarea
    function insertExample(element) {
        const textarea = document.getElementById('user_motif');
        const example = element.textContent;
        if (textarea.value) {
            textarea.value += ' | ' + example;
        } else {
            textarea.value = example;
        }
        textarea.focus();
    }

    // Output tab switching
    document.querySelectorAll('.output-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            const tabId = 'tab-' + this.dataset.tab;
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Conditional section visibility
    function updateConditionalSections() {
        // Markov options
        const useMarkov = document.getElementById('use_markov');
        if (useMarkov) {
            document.getElementById('markov-options').style.display = useMarkov.checked ? 'block' : 'none';
        }

        // Dynamics options
        const useDynamics = document.getElementById('use_dynamics');
        if (useDynamics) {
            document.getElementById('dynamics-options').style.display = useDynamics.checked ? 'block' : 'none';
        }

        // Bass options
        const addBass = document.getElementById('add_bass');
        if (addBass) {
            document.getElementById('bass-options').style.display = addBass.checked ? 'block' : 'none';
        }

        // Genetic options
        const method = document.getElementById('generation_method');
        if (method) {
            document.getElementById('genetic-options').style.display = (method.value === 'genetic') ? 'block' : 'none';
        }
    }

    // Range value display
    function updateRangeValues() {
        const climaxPos = document.getElementById('climax_position');
        const climaxVal = document.getElementById('climax_value');
        if (climaxPos && climaxVal) {
            climaxVal.textContent = climaxPos.value;
        }

        const markovWeight = document.getElementById('markov_weight');
        const markovVal = document.getElementById('markov_value');
        if (markovWeight && markovVal) {
            markovVal.textContent = markovWeight.value;
        }
    }

    // Event listeners
    const useMarkov = document.getElementById('use_markov');
    if (useMarkov) useMarkov.addEventListener('change', updateConditionalSections);

    const useDynamics = document.getElementById('use_dynamics');
    if (useDynamics) useDynamics.addEventListener('change', updateConditionalSections);

    const addBass = document.getElementById('add_bass');
    if (addBass) addBass.addEventListener('change', updateConditionalSections);

    const genMethod = document.getElementById('generation_method');
    if (genMethod) genMethod.addEventListener('change', updateConditionalSections);

    const climaxPos = document.getElementById('climax_position');
    if (climaxPos) {
        climaxPos.addEventListener('input', function() {
            document.getElementById('climax_value').textContent = this.value;
        });
    }

    const markovWeight = document.getElementById('markov_weight');
    if (markovWeight) {
        markovWeight.addEventListener('input', function() {
            document.getElementById('markov_value').textContent = this.value;
        });
    }

    // Initialize
    updateConditionalSections();
    updateRangeValues();
</script>
{% endblock %}
